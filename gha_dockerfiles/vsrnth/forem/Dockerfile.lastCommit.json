[{"sha":"aa49cb1cfe640bfb75c5c411e509ab1e61708198","node_id":"MDY6Q29tbWl0MzQ3MTM5NzU4OmFhNDljYjFjZmU2NDBiZmI3NWM1YzQxMWU1MDlhYjFlNjE3MDgxOTg=","commit":{"author":{"name":"Joe Doss","email":"jdoss@users.noreply.github.com","date":"2020-05-28T17:11:51Z"},"committer":{"name":"GitHub","email":"noreply@github.com","date":"2020-05-28T17:11:51Z"},"message":"Bugfix for #7663 and refactor of container setup (#7747)\n\n* Move from Alpine Linux to Fedora Linux.\r\n\r\nThis changes the base container image away from Alpine Linux to\r\nFedora Linux to address some musl libc issues with some of our gems.\r\n\r\nIt also moved the main file to a Containerfile and symlinks the Dockerfile\r\nto it. This makes our container setup less Docker-centric as Linux users\r\nmost likely will be using Podman as their container runtime.\r\n\r\nLastly, it moves the WORKDIR from /usr/src/app to /opt/apps/devto.\r\nThe Linux FHS states that /opt is the spot for Optional application\r\nsoftware packages and /usr/src is for kernel source code.\r\n\r\nhttps://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard\r\n\r\n/opt Optional application software packages\r\n/usr/src Source code, e.g., the kernel source code with its header files.\r\n\r\nAlso, if SELinux becomes a thing in our future, moving this makes it\r\neasier to manage contexts out of /opt rather than /usr/src.\r\n\r\n* Adjust the Containerfile a bit to add some missing packages, make it\r\nmore generic and move env vars to the docker-compose.\r\n\r\n* Move the Dockerfile to a symlink to the Containerfile.\r\n\r\nWe need to be able to support more than just Docker for a container\r\nruntime. Moving everything to a Containerfile and symlinking the\r\nDockerfile helps users run runtimes such as Podman.\r\n\r\n* Add in new entrypoint files and fix the app path in docker-entrypoint.sh\r\n\r\n* Refactor the docker-compose.yml file so it doesn't build the main\r\napplication container three times in a row. We can use the same\r\ncontainer for web, webpacker, and sidekiq.\r\n\r\nAlso make the volume names very explicit on what their contents and add\r\nin SELinux context support with :Z\r\n\r\n* Fix ELASTICSEARCH_URL.\r\n\r\n* Remove the absolute path on ip binary and add in iproute to Containerfile.\r\n\r\n* Symlink the Dockerfile to Containerfile and add in a container-compose.yml file\r\nfor usage with podman-compose. We are waiting for this issue to get resolved\r\n\r\nhttps://github.com/containers/libpod/issues/6153\r\n\r\nand for podman-compose to mature a bit more. A user using podman-compose can use\r\n\r\npodman-compose -f container-compose.yml\r\n\r\nto launch the DEV container stack with Podman.\r\n\r\n* Update the .gitignore file to reflect the new container volumes.\r\n\r\n* Fix the entrypoint script on the Containerfile and clean up a bunch of things.\r\n\r\n* Rework the Containerfile to prep it to run as a non-root user. We have to wait\r\nfor this issue to get fixed:\r\n\r\nhttps://github.com/containers/libpod/issues/6153\r\n\r\nfor Linux users and then we can uncomment the USER line so we are running Rails\r\nas a non-root user. :toot:\r\n\r\n* This reworks the compose files so each task that is needed to start the app has\r\na correct wait command with dockerize. It also adds in containers for doing\r\nyarn and bundle things for development. Since we mount the code directory inside\r\nthe container we lose our pre-containerized gems and node_modules.\r\n\r\nThis means users can run:\r\n\r\nLinux\r\npodman-compose -f container-compose.yml up\r\n\r\nMac\r\ndocker-compose up\r\n\r\nand it should correctly build the app stack with containers!\r\n\r\n* Clean up old container related things.\r\n\r\n* Add in some container pre-reqs and my name to the \"Core team\" section! :toot:\r\n\r\n* Adjust the seed and sidekiq compose entries so they do not use the web entrypoint\r\nand set the REDIS_URL and REDIS_SESSIONS_URL env vars for seed.\r\n\r\nAdd in some echos to the entrypoint.sh.\r\n\r\nAlso set docker-compose to use :delegated on mount points to speed things up.\r\n\r\nhttps://docs.docker.com/storage/bind-mounts/#configure-mount-consistency-for-macos\r\n\r\n* Just call yarn install --dev on the yarn container.\r\n\r\n* Update documentation to support Docker and Podman as Container Engines and\r\nmove the page from docker to containers to reflect the fact not all users run\r\ntheir containers via Docker.\r\n\r\nThere are dozens of us... DOZENS!\r\n\r\n* Set --local on bundle config so it just impacts this Ruby app.\r\n\r\n* Renamed bin/docker-setup to bin/container-setup to reflect the fact that that\r\nwe can use Podman as a container engine. I also refactored it so it does some\r\nbasic pre-flight checks for docker and docker-compose or podman and\r\npodman-compose to make sure users have a container engine installed.\r\n\r\n* Set cache_all_platforms true for bundler.\r\n\r\n* Bump docker-compose dockerize -timeout to 45min for slower macOS hardware.\r\n\r\n* Move to the consolidated app_initializer:setup rake task for bootstrapping the\r\napp.\r\n\r\n* Update docs/installation/readme.md","tree":{"sha":"65eeceb8bcc74c6918ca29d7bc296b7e08ff0e7d","url":"https://api.github.com/repos/vsrnth/forem/git/trees/65eeceb8bcc74c6918ca29d7bc296b7e08ff0e7d"},"url":"https://api.github.com/repos/vsrnth/forem/git/commits/aa49cb1cfe640bfb75c5c411e509ab1e61708198","comment_count":0,"verification":{"verified":true,"reason":"valid","signature":"-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJez/DXCRBK7hj4Ov3rIwAAdHIIAEkjly5tAi30UqzFrR5W6rbn\n8DTvNem2Chqm/B+B1VCRKOHTWfjxaAIT13Xif8bYV/MmK7XC0ATj8uMBvPrsefjA\nuQOW9Hfr0MDnGXG2c7TzY8oh6mQvrpNZXXu4UJCJt7Fmowgh+3IYDSD46UQNV4Bv\nnAPOPAuWAUZzhm3Ru0beGQftAHbe7xwBlU1UjjFqtXp4BpfOkDqjsUv2c8BFUqTR\npHLZhYOqbRSAdls99IE5cfFkVjxO47al5MFuda7fSJ3XaLmt5BGE12Jpc5K3kfJ7\n7mNSGDpZpz4UDEBNj26re4RKyx9EYArv3FDOxLGIMYn3DjcO5Vx/r8N9Vk1zkwk=\n=1uMv\n-----END PGP SIGNATURE-----\n","payload":"tree 65eeceb8bcc74c6918ca29d7bc296b7e08ff0e7d\nparent 1a40e10df8d82ed06d4c37cb5a05f4ea71efed0d\nauthor Joe Doss <jdoss@users.noreply.github.com> 1590685911 -0500\ncommitter GitHub <noreply@github.com> 1590685911 -0500\n\nBugfix for #7663 and refactor of container setup (#7747)\n\n* Move from Alpine Linux to Fedora Linux.\r\n\r\nThis changes the base container image away from Alpine Linux to\r\nFedora Linux to address some musl libc issues with some of our gems.\r\n\r\nIt also moved the main file to a Containerfile and symlinks the Dockerfile\r\nto it. This makes our container setup less Docker-centric as Linux users\r\nmost likely will be using Podman as their container runtime.\r\n\r\nLastly, it moves the WORKDIR from /usr/src/app to /opt/apps/devto.\r\nThe Linux FHS states that /opt is the spot for Optional application\r\nsoftware packages and /usr/src is for kernel source code.\r\n\r\nhttps://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard\r\n\r\n/opt Optional application software packages\r\n/usr/src Source code, e.g., the kernel source code with its header files.\r\n\r\nAlso, if SELinux becomes a thing in our future, moving this makes it\r\neasier to manage contexts out of /opt rather than /usr/src.\r\n\r\n* Adjust the Containerfile a bit to add some missing packages, make it\r\nmore generic and move env vars to the docker-compose.\r\n\r\n* Move the Dockerfile to a symlink to the Containerfile.\r\n\r\nWe need to be able to support more than just Docker for a container\r\nruntime. Moving everything to a Containerfile and symlinking the\r\nDockerfile helps users run runtimes such as Podman.\r\n\r\n* Add in new entrypoint files and fix the app path in docker-entrypoint.sh\r\n\r\n* Refactor the docker-compose.yml file so it doesn't build the main\r\napplication container three times in a row. We can use the same\r\ncontainer for web, webpacker, and sidekiq.\r\n\r\nAlso make the volume names very explicit on what their contents and add\r\nin SELinux context support with :Z\r\n\r\n* Fix ELASTICSEARCH_URL.\r\n\r\n* Remove the absolute path on ip binary and add in iproute to Containerfile.\r\n\r\n* Symlink the Dockerfile to Containerfile and add in a container-compose.yml file\r\nfor usage with podman-compose. We are waiting for this issue to get resolved\r\n\r\nhttps://github.com/containers/libpod/issues/6153\r\n\r\nand for podman-compose to mature a bit more. A user using podman-compose can use\r\n\r\npodman-compose -f container-compose.yml\r\n\r\nto launch the DEV container stack with Podman.\r\n\r\n* Update the .gitignore file to reflect the new container volumes.\r\n\r\n* Fix the entrypoint script on the Containerfile and clean up a bunch of things.\r\n\r\n* Rework the Containerfile to prep it to run as a non-root user. We have to wait\r\nfor this issue to get fixed:\r\n\r\nhttps://github.com/containers/libpod/issues/6153\r\n\r\nfor Linux users and then we can uncomment the USER line so we are running Rails\r\nas a non-root user. :toot:\r\n\r\n* This reworks the compose files so each task that is needed to start the app has\r\na correct wait command with dockerize. It also adds in containers for doing\r\nyarn and bundle things for development. Since we mount the code directory inside\r\nthe container we lose our pre-containerized gems and node_modules.\r\n\r\nThis means users can run:\r\n\r\nLinux\r\npodman-compose -f container-compose.yml up\r\n\r\nMac\r\ndocker-compose up\r\n\r\nand it should correctly build the app stack with containers!\r\n\r\n* Clean up old container related things.\r\n\r\n* Add in some container pre-reqs and my name to the \"Core team\" section! :toot:\r\n\r\n* Adjust the seed and sidekiq compose entries so they do not use the web entrypoint\r\nand set the REDIS_URL and REDIS_SESSIONS_URL env vars for seed.\r\n\r\nAdd in some echos to the entrypoint.sh.\r\n\r\nAlso set docker-compose to use :delegated on mount points to speed things up.\r\n\r\nhttps://docs.docker.com/storage/bind-mounts/#configure-mount-consistency-for-macos\r\n\r\n* Just call yarn install --dev on the yarn container.\r\n\r\n* Update documentation to support Docker and Podman as Container Engines and\r\nmove the page from docker to containers to reflect the fact not all users run\r\ntheir containers via Docker.\r\n\r\nThere are dozens of us... DOZENS!\r\n\r\n* Set --local on bundle config so it just impacts this Ruby app.\r\n\r\n* Renamed bin/docker-setup to bin/container-setup to reflect the fact that that\r\nwe can use Podman as a container engine. I also refactored it so it does some\r\nbasic pre-flight checks for docker and docker-compose or podman and\r\npodman-compose to make sure users have a container engine installed.\r\n\r\n* Set cache_all_platforms true for bundler.\r\n\r\n* Bump docker-compose dockerize -timeout to 45min for slower macOS hardware.\r\n\r\n* Move to the consolidated app_initializer:setup rake task for bootstrapping the\r\napp.\r\n\r\n* Update docs/installation/readme.md\r\n"}},"url":"https://api.github.com/repos/vsrnth/forem/commits/aa49cb1cfe640bfb75c5c411e509ab1e61708198","html_url":"https://github.com/vsrnth/forem/commit/aa49cb1cfe640bfb75c5c411e509ab1e61708198","comments_url":"https://api.github.com/repos/vsrnth/forem/commits/aa49cb1cfe640bfb75c5c411e509ab1e61708198/comments","author":{"login":"jdoss","id":8195,"node_id":"MDQ6VXNlcjgxOTU=","avatar_url":"https://avatars.githubusercontent.com/u/8195?v=4","gravatar_id":"","url":"https://api.github.com/users/jdoss","html_url":"https://github.com/jdoss","followers_url":"https://api.github.com/users/jdoss/followers","following_url":"https://api.github.com/users/jdoss/following{/other_user}","gists_url":"https://api.github.com/users/jdoss/gists{/gist_id}","starred_url":"https://api.github.com/users/jdoss/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdoss/subscriptions","organizations_url":"https://api.github.com/users/jdoss/orgs","repos_url":"https://api.github.com/users/jdoss/repos","events_url":"https://api.github.com/users/jdoss/events{/privacy}","received_events_url":"https://api.github.com/users/jdoss/received_events","type":"User","site_admin":false},"committer":{"login":"web-flow","id":19864447,"node_id":"MDQ6VXNlcjE5ODY0NDQ3","avatar_url":"https://avatars.githubusercontent.com/u/19864447?v=4","gravatar_id":"","url":"https://api.github.com/users/web-flow","html_url":"https://github.com/web-flow","followers_url":"https://api.github.com/users/web-flow/followers","following_url":"https://api.github.com/users/web-flow/following{/other_user}","gists_url":"https://api.github.com/users/web-flow/gists{/gist_id}","starred_url":"https://api.github.com/users/web-flow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/web-flow/subscriptions","organizations_url":"https://api.github.com/users/web-flow/orgs","repos_url":"https://api.github.com/users/web-flow/repos","events_url":"https://api.github.com/users/web-flow/events{/privacy}","received_events_url":"https://api.github.com/users/web-flow/received_events","type":"User","site_admin":false},"parents":[{"sha":"1a40e10df8d82ed06d4c37cb5a05f4ea71efed0d","url":"https://api.github.com/repos/vsrnth/forem/commits/1a40e10df8d82ed06d4c37cb5a05f4ea71efed0d","html_url":"https://github.com/vsrnth/forem/commit/1a40e10df8d82ed06d4c37cb5a05f4ea71efed0d"}]}]